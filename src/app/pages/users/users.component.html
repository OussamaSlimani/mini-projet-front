<div class="card">
    <p-toast position="top-right"></p-toast>
    <p-confirmDialog [style]="{width: '500px'}"></p-confirmDialog>

    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold flex items-start gap-3">
            User Management
        </h2>
    </div>

    <!-- Action bar -->
    <div class="flex flex-wrap justify-between items-center gap-4 mb-6 p-4 rounded-lg">
        <div class="flex flex-wrap gap-2">
            <!-- Create button -->
            <button pButton icon="pi pi-plus" label="New User" class="p-button-primary shadow-sm"
                (click)="showAddDialog()"></button>

            <!-- Delete button (shown when selection exists) -->
            <button *ngIf="selectedUsers.length > 0" pButton label="Delete" icon="pi pi-trash"
                class="p-button-outlined p-button-danger shadow-sm" (click)="confirmDeleteMultiple()"></button>
        </div>

        <div *ngIf="selectedUsers.length > 0" class="flex items-center gap-2">
            <p-badge [value]="selectedUsers.length" severity="info"></p-badge>
            <span class="text-sm font-medium text-gray-600">selected</span>
        </div>
    </div>

    <!-- Table with multiple selection and no filters -->
    <p-table [value]="users" class="mb-4 shadow-sm" [responsiveLayout]="'scroll'"
        [(selection)]="selectedUsers" dataKey="id" styleClass="p-datatable-striped p-datatable-gridlines p-datatable-sm">
        
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th pSortableColumn="username">Username <p-sortIcon field="username"></p-sortIcon></th>
                <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
                <th pSortableColumn="role">Role <p-sortIcon field="role"></p-sortIcon></th>
                <th pSortableColumn="createdAt">Created At <p-sortIcon field="createdAt"></p-sortIcon></th>
                <th class="text-center">Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-user>
            <tr [pSelectableRow]="user">
                <td>
                    <p-tableCheckbox [value]="user"></p-tableCheckbox>
                </td>
                <td class="font-medium">{{ user.username }}</td>
                <td class="font-medium">{{ user.email }}</td>
                <td class="font-medium">
                    <p-tag [value]="user.role" 
                           [severity]="user.role === 'admin' ? 'danger' : 'info'"></p-tag>
                </td>
                <td class="font-medium">{{ user.createdAt | date:'mediumDate' }}</td>
                <td class="text-center">
                    <div class="flex gap-2 justify-content-center">
                        <button pButton type="button" icon="pi pi-pencil"
                            class="p-button-rounded p-button-text p-button-sm p-button-info"
                            (click)="showEditDialog(user)" pTooltip="Edit" tooltipPosition="top"></button>
                        <button pButton type="button" icon="pi pi-trash"
                            class="p-button-rounded p-button-text p-button-sm p-button-info"
                            (click)="confirmDeleteSingle(user)" pTooltip="Delete" tooltipPosition="top"></button>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6" class="text-center py-6 text-gray-500">
                    <i class="pi pi-search text-2xl mb-2"></i>
                    <p>No users found</p>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Add/Edit User Dialog -->
    <p-dialog [header]="isEditing ? 'Edit User' : 'Add New User'" [(visible)]="showDialog"
        [modal]="true" [style]="{width: '500px'}" [closable]="true" [breakpoints]="{'960px': '75vw', '640px': '90vw'}"
        [draggable]="false">
        <div class="flex flex-col gap-4 p-fluid">
            <div class="field">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input id="username" type="text" pInputText [(ngModel)]="currentUser.username" required
                    class="w-full" autocomplete="off" />
            </div>
            <div class="field">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input id="email" type="email" pInputText [(ngModel)]="currentUser.email" required
                    class="w-full" autocomplete="off" />
            </div>
            <div class="field">
                <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <p-dropdown [options]="roleOptions" [(ngModel)]="currentUser.role" 
                    optionLabel="label" optionValue="value" [style]="{'width':'100%'}"></p-dropdown>
            </div>
            <div class="field">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input id="password" type="password" pInputText [(ngModel)]="currentUser.password" 
                    [required]="!isEditing" class="w-full" autocomplete="new-password" />
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2">
                <button pButton label="Cancel" icon="pi pi-times" (click)="closeDialog()"
                    class="p-button-outlined p-button-secondary"></button>
                <button pButton [label]="isEditing ? 'Update' : 'Add'" icon="pi pi-check" (click)="saveUser()"
                    class="p-button-primary"
                    [disabled]="!currentUser.username || !currentUser.email || (!isEditing && !currentUser.password)"></button>
            </div>
        </ng-template>
    </p-dialog>
</div>
